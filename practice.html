<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practicar - MecanoClass</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="css/styles.css" rel="stylesheet">
    <style>
        .typing-area {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            line-height: 1.8;
            white-space: pre-wrap;
            user-select: none;
            position: relative;
        }

        .char-correct {
            color: #4ade80;
            /* bright green */
        }

        .char-incorrect {
            color: #f87171;
            text-decoration: underline;
            /* bright red */
        }

        .char-current {
            background-color: rgba(99, 102, 241, 0.4);
            border-bottom: 2px solid var(--primary-color);
            color: white;
            animation: pulse-caret 1s infinite;
        }

        @keyframes pulse-caret {
            50% {
                border-bottom-color: transparent;
            }
        }

        /* Hide actual input but keep focus */
        #hiddenInput {
            position: absolute;
            opacity: 0;
            top: 0;
            left: 0;
            height: 0;
            width: 0;
        }
    </style>
</head>

<body>

    <div id="app-header"></div>

    <div class="container py-5 flex-grow-1">
        <div class="row justify-content-center">
            <div class="col-lg-10">

                <!-- Stats Header -->
                <div class="d-flex justify-content-between mb-4">
                    <div class="glass-panel px-4 py-2 text-center flex-fill mx-2">
                        <span class="text-dim text-uppercase small">PPM</span>
                        <h2 class="text-light fw-bold mb-0" id="wpmDisplay">0</h2>
                    </div>
                    <div class="glass-panel px-4 py-2 text-center flex-fill mx-2">
                        <span class="text-dim text-uppercase small">Precisi√≥n</span>
                        <h2 class="text-light fw-bold mb-0" id="accuracyDisplay">100%</h2>
                    </div>
                </div>

                <!-- Typing Box --\u003e
                <div id="gameContainer" class="glass-panel p-5 position-relative">
                    <!-- Platform Game Canvas -->
                <canvas id="platformGameCanvas" class="w-100 mb-3" style="border-radius: 8px;"></canvas>

                <div id="textDisplay" class="typing-area text-secondary">Cargando texto...</div>
                <input type="text" id="hiddenInput" autocomplete="off" spellcheck="false">

                <div id="overlayStart"
                    class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-75 rounded-3"
                    style="z-index: 10;">
                    <button type="button" class="btn btn-premium btn-lg" onclick="startPractice(event)">
                        <i class="bi bi-play-fill me-2"></i>Comenzar
                    </button>
                </div>

                <div id="overlayEnd"
                    class="position-absolute top-0 start-0 w-100 h-100 align-items-center justify-content-center bg-dark bg-opacity-95 rounded-3"
                    style="z-index: 11; display: none;">
                    <div class="text-center">
                        <h2 class="text-success mb-3">¬°Completado!</h2>
                        <h1 class="display-3 text-light fw-bold mb-4" id="finalWpm">0 PPM</h1>
                        <div class="d-flex gap-3 justify-content-center">
                            <button class="btn btn-outline-light" onclick="location.reload()">Repetir</button>
                            <button class="btn btn-premium" onclick="saveAndExit()">Guardar Resultado</button>
                        </div>
                    </div>
                </div>

                <!-- Failed Overlay (accuracy < 90%) -->
                <div id="overlayFailed"
                    class="position-absolute top-0 start-0 w-100 h-100 align-items-center justify-content-center bg-dark bg-opacity-95 rounded-3"
                    style="z-index: 11; display: none;">
                    <div class="text-center">
                        <h2 class="text-danger mb-3">‚ùå Precisi√≥n Insuficiente</h2>
                        <p class="text-light mb-2">Necesitas al menos <span class="text-warning fw-bold">90% de
                                precisi√≥n</span> para guardar</p>
                        <h3 class="text-light mb-1">Tu precisi√≥n: <span id="failedAccuracy"
                                class="text-danger">0%</span></h3>
                        <p class="text-dim mb-4">Velocidad: <span id="failedWpm">0 PPM</span></p>
                        <button class="btn btn-premium" onclick="location.reload()">üîÑ Vuelve a Intentarlo</button>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-center text-dim">
                <small>Haz clic en el recuadro para enfocar ‚Ä¢ Pulsa ESC para reiniciar</small>
            </div>

        </div>
    </div>
    </div>

    <div id="app-footer"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/components.js"></script>
    <script src="js/initial_texts.js"></script>
    <script src="js/db.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/platform-game.js"></script>
    <script src="js/typing-engine.js"></script>
    <script>
        let engine;
        let currentClassId = null;
        let practiceText = ''; // Store text for summary

        document.addEventListener('DOMContentLoaded', async () => {
            // Get classId from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentClassId = urlParams.get('classId');

            // Fetch random text
            document.getElementById('textDisplay').innerText = currentClassId
                ? "Cargando texto de la clase..."
                : "Cargando texto aleatorio...";

            let textData;
            // Note: getPracticeTextForClass returns logic {text, ...} or string? 
            // In db.js I implemented it to return the OBJECT. getRandomPracticeText returned STRING (Wait, check db.js line 197: return randomDoc.data().text).
            // getPracticeTextForClass returned `pool[randomIndex]`. Which is an object.
            // So I need to handle both types or standardize.

            try {
                if (currentClassId) {
                    const result = await getPracticeTextForClass(currentClassId);
                    textData = result ? result.text : "No hay textos disponibles en esta clase.";
                } else {
                    textData = await getRandomPracticeText();
                }
            } catch (e) {
                console.error("Error fetching text", e);
                textData = "Error al cargar texto. Usa este texto de ejemplo.";
            }

            practiceText = textData; // Store for summary

            // Initialize platform game
            const game = new PlatformGame('platformGameCanvas');

            // Set user avatar if available
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const profile = await getUserProfile(user.uid);
                    if (profile && profile.photoURL) {
                        game.setAvatar(profile.photoURL);
                    }
                }
            });

            engine = new TypingEngine(textData, {
                onComplete: showResults,
                onUpdate: (wpm, accuracy) => {
                    updateStats(wpm, accuracy);

                    // Update game stats for progress bar
                    game.progress = engine.position / engine.text.length;
                    game.accuracy = accuracy / 100;
                    game.draw(); // Redraw to update progress bar
                },
                onCorrectKey: () => {
                    game.onCorrectKey(); // Trigger jump animation

                    // Update position based on correct keys only
                    const correctKeys = engine.position - engine.errors;
                    game.updatePosition(correctKeys, engine.text.length);
                },
                onIncorrectKey: () => {
                    // Character doesn't move on incorrect key
                    game.draw(); // Redraw to update progress bar color
                }
            });

            // ESC to restart
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    location.reload();
                }
            });
        });

        function startPractice(event) {
            if (event) event.stopPropagation();

            if (!engine) return console.error("Engine not initialized");

            const overlay = document.getElementById('overlayStart');
            overlay.style.display = 'none';
            overlay.classList.remove('d-flex');
            const input = document.getElementById('hiddenInput');
            input.focus();

            // Enable click-to-focus on container now that game started
            const gameContainer = document.getElementById('gameContainer');
            if (gameContainer) {
                gameContainer.onclick = function () {
                    input.focus();
                };
            }

            engine.start();
        }

        function updateStats(wpm, accuracy) {
            document.getElementById('wpmDisplay').innerText = wpm;
            document.getElementById('accuracyDisplay').innerText = accuracy + '%';
        }

        function showResults(stats) {
            // Check if accuracy meets minimum requirement (90%)
            if (stats.accuracy < 90) {
                // Failed - accuracy too low
                document.getElementById('overlayFailed').style.display = 'flex';
                document.getElementById('failedAccuracy').innerText = stats.accuracy + '%';
                document.getElementById('failedWpm').innerText = stats.wpm + ' PPM';
            } else {
                // Passed - show results and allow saving
                document.getElementById('overlayEnd').style.display = 'flex';
                document.getElementById('finalWpm').innerText = stats.wpm + ' PPM';
                // Store stats for saving
                engine.finalStats = stats;
            }
        }

        async function saveAndExit() {
            const user = firebase.auth().currentUser;
            if (user && engine && engine.finalStats) {
                const btn = document.querySelector('#overlayEnd .btn-premium');
                const originalText = btn.innerText;
                btn.innerText = "Guardando...";
                btn.disabled = true;

                try {
                    // Calculate duration in seconds
                    const duration = engine.endTime && engine.startTime
                        ? Math.round((engine.endTime - engine.startTime) / 1000)
                        : null;

                    // Create text summary (first 50 chars)
                    const textSummary = practiceText.substring(0, 50);

                    // saveResult(studentId, wpm, accuracy, mode, classId, textSummary, duration)
                    await saveResult(
                        user.uid,
                        engine.finalStats.wpm,
                        engine.finalStats.accuracy,
                        'practice',
                        currentClassId, // Helper handles null
                        textSummary,
                        duration
                    );
                    alert("¬°Resultado guardado correctamente!");

                    if (currentClassId) {
                        window.location.href = 'dashboard_student.html';
                    } else {
                        window.history.back();
                    }
                } catch (error) {
                    console.error("Error saving result:", error);
                    alert("Error al guardar: " + error.message);
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } else {
                if (!user) {
                    alert("Debes iniciar sesi√≥n para guardar resultados.");
                    window.location.href = 'index.html';
                }
            }
        }
    </script>
</body>

</html>